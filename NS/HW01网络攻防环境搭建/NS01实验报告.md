# 网络安全实验报告1

## 一.实验要求：
  [] 靶机可以直接访问攻击者主机</br>
  [] 攻击者主机无法直接访问靶机</br>
  [] 网关可以直接访问攻击者主机和靶机</br>
  [] 靶机的所有对外上下行流量必须经过网关</br>
  [] 所有节点均可访问互联网</br>
  [] 虚拟硬盘的多重加载</br>

## 二.实验环境配置：
***
### 1.虚拟硬盘的多重加载:</br>
![](多重加载.PNG)</br>
实验前安装好的虚拟机-设置-存储-类型中为普通，首先对虚拟网络介质进行更改为多重加载：
![](虚拟介质管理.PNG)</br>
如图所示，多重加载的好处之一就是新建虚拟机时环境为配置好的，不需要重新配置环境（图中三个加载点）
### 2.实验拓扑图及VirtualBox 网络连接模式:</br>
使用packet tracer绘制的网络拓扑图如下：</br>
![](拓扑图.PNG)</br>
本次实验中选择了NAT network及Host-only模式，网络连接模式如下所示：</br>
![network connecting](网络连接方式.PNG "参考资料1") 
</br>

### 3.实验靶机，攻击者及网关的网络配置:</br>
网关的配置：全局设定-网络-添加新的NAT网络：</br>
![](全局设定.PNG)</br>
![](网关第一块网卡设置.PNG)</br>
![](网关第二块网卡设置.PNG)</br>
靶机及攻击者网络设置：</br>
![](靶机网络配置.PNG)</br>
![](攻击者网络配置.PNG)</br>

进入kali系统后，分别对三个虚拟机的四块网卡进行设置:
其中攻击者的ip和网关同一网段的网卡由DHCP服务器自动配置，ipconfig查看攻击者ip：</br>
![](攻击者ip地址.PNG)
![](网关ip地址.PNG)</br>
网关另一网卡与靶机在同一网段内：</br>
![](网关ip地址.PNG)
![](靶机ip地址.PNG)

## 三.实验过程：
### 1.网关ping通靶机：</br>
从图中可以得知网关可以ping通靶机：</br>
![](网关ping通靶机.PNG)

### 2.网关ping通攻击者：</br>
从图中可以看出网关可以ping通攻击者：</br>
![](网关ping通攻击者.PNG)

### 3.靶机ping攻击者：</br>
![](靶机ping攻击者1.PNG)</br>
可以看出现在并不能ping通攻击者，由于靶机的默认网关为192.168.70.129，所以我们使用kali内置的工具tcpdump对eth0（与靶机在同一网段内）进行抓包：</br>
![](抓包eth0网卡.PNG)</br>
全部都是包含request的ICMP包，也就是说我们没有得到有攻击者主机返回的reply包。
同理，当我们对eth1进行抓包时，什么都没有，是因为没有开启网关的ip_forward,当包到达eth0时，并不能自动转发到eth1上，添加指令：</br>
![](开启转发.PNG)</br>
可以得到下图：</br>
![](抓包eth1端口.PNG)</br>
此时，所有的ICMP包已经可以穿过路由，但是依旧得不到攻击者主机的回应，此时我遇到了本次实验的最大问题，留到第四部分进行叙述。
解决了最大的问题后，再次对eth1进行抓包，发现依旧无法获得reply包，推测是由于：当靶机发送ICMP包时，攻击者主机收到ICMP包后，首先看是不是同一网段，不是同一网段，则递交给攻击者主机的默认网关，默认网关在本实验中为：</br>
![](主机默认网关.PNG)</br>
而默认网关连接到了外网（因特网），所以这个回复包就相当于丢了。
为了使得reply包可以顺利到达靶机，我们进行网关上iptable的配置（实际上路由的功能就是起到替换源地址为网关地址的作用）：</br>
![](初始防火墙.PNG)</br>
我们在图中看见，初始的iptable只有input，output和forward三条链，而每条链中没有一张表和一个规则。那么我们的目的是替换靶机的IP地址为网关的IP地址，这样主机就会将reply包发回网关（非默认网关，实验中eth1）我们对防火墙添加一条规则在nat表上（因为nat表是转换地址的规则集合，事实上表才是规则的操作入口）原本我想为什么不将其添加在prerouting上，而是postrouting（参见钟总教程），而后发现：</br>
![](prerouting.PNG)</br>
当然这是由于我对防火墙的指令还不会书写的原因，截至目前还在探索，所以中规中矩的按照钟总的实验报告写下了：</br>
![](防火墙设置.PNG)</br>
所以就ping通主机了!
![](靶机ping通主机.PNG)

### 4.攻击者主机ping靶机：</br>
![](主机ping靶机.PNG)</br>
那当然是ping不通了。

### 5.所有节点访问互联网及经过网关流量：</br>
首先是网关可以ping百度：</br>
![](ping互联网.PNG)</br>
然后因为是手动配置的靶机，所以DNS服务器我们配置好后就可以上网了（DNS服务器本次试验中设为网关）：</br>
![](DNS.PNG)</br>
当然我们需要安装：dnsmasq（依旧参考钟总的实验报告）
最后我们用攻击者主机ping百度：</br>
![](主机ping百度.PNG)</br>
而且在步骤3中的对靶机和网关抓包对比抓到的包可以得出结论：</br>
靶机的所有对外上下行流量经过网关</br>

## 四.本次实验遇到的最大问题及心路历程：</br>
接下来就是困扰了我很久的问题了，在第一次实验中，我们得不到返回的reply包，并不是因为我们没有做替换，而是我对攻击者主机抓包后分析发现，攻击者主机压根就没有产生reply包！！</br>
这就让我产生了不解，按理说这是不可能的事情，我猜测是因为我的攻击者主机对ICMP协议禁用了，但是和网关可以互相ping通否定了我的结论。那么难道是路由的问题，比如说路由的arp表遭到了污染导致ICMP包到了奇奇怪怪的地方？当然也是不可能的。因为主机是明确收到了request的。那么在我力所能及之外的，我就只好进行重新配置攻击者主机网卡了，在remove所有的配置后，重新自动分配IP后，再次ping的时候就产生了reply包（虽然说重启大法好，但是这种奇奇怪怪的问题依旧没有弄明白）

## 五.参考资料：
1.VirtualBox官方网站（网络连接模式):</br>https://www.virtualbox.org/manual/ch06.html</br>
2.钟总的实验报告